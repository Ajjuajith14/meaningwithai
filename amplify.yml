version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - npm ci
            - echo "Build-time environment check:"
            - 'echo "GETIMG_API_KEY: ${GETIMG_API_KEY:0:10}...hidden"'
            - 'echo "OPENAI_API_KEY: ${OPENAI_API_KEY:0:10}...hidden"'
            - 'echo "NEXT_PUBLIC_SUPABASE_URL: $NEXT_PUBLIC_SUPABASE_URL"'
        build:
          commands:
            - npm run build
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
      environment:
        variables:
          NODE_ENV: production
          AMPLIFY_MONOREPO_APP_ROOT: /
          AMPLIFY_DIFF_DEPLOY: false
          AMPLIFY_DIFF_DEPLOY_ROOT: /
          _LIVE_UPDATES: '[{"name":"Node.js","pkg":"node","type":"nvm","version":"20"}]'
          # Runtime environment variables for Next.js API routes
          OPENAI_API_KEY: $OPENAI_API_KEY
          GETIMG_API_KEY: $GETIMG_API_KEY
          NEXT_PUBLIC_SUPABASE_URL: $NEXT_PUBLIC_SUPABASE_URL